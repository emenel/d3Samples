<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="libs/d3.v4.min.js"></script>
  <style>
    body { margin:20;position:fixed;top:0;right:0;bottom:0;left:0; }
    svg { width:100%; height: 100% }


  </style>
</head>

<body>
  <script>

    var width = 1200;
    var height = 800;
    var min;
    var max;

    var svg = d3.select("body").append("svg")

		var data = "data/forestArea.csv";

    function parseData(dataset) {

      var countriesData = d3.nest()
        .key(function(d){
          return d.CountryCode;
        })
        .rollup(function(d){
          var dmap = d3.map(d[0]).entries();

          var years = d3.map();
          var meta = d3.map();

          for (var i = 0; i < dmap.length; i++) {
            if (!isNaN(parseInt(dmap[i].key))) {
              years.set(dmap[i].key, dmap[i].value);
            } else {
              meta.set(dmap[i].key, dmap[i].value);
            }
          }

          min = d3.min(years.keys());
          max = d3.max(years.keys());

          return {
            'years': years,
            'meta': meta
          }
        })
        .entries(dataset);

      return countriesData;
    }


		d3.csv(data, function(err, forestData) {

      var countriesData = parseData(forestData);

        //console.log(countriesData);

      var xScale = d3.scaleLinear()
        .domain([parseInt(min), parseInt(max)])
        .range([0, width-10]);

      var yScale = d3.scaleLinear()
        .domain([min, max])
        .range([0, height])

      // console.log(countriesData);

      svg.selectAll('.countries')
        .data(countriesData)
        .enter().append('g')
          .attr('id', function(d){
            return d.key;
          })
        .selectAll('.country')
          .data(function(d){
            var inc = d3.map();
            d.value.years.each(function(v,k){
              if (v) { inc.set(k,v); }
            });
            return inc.entries();
          })
          .enter().append('circle')
            .attr('cx', function(d,i){
              // console.log(parseInt(d.key));
              return xScale(d.key)
            })
            .attr('cy', 200)
            .attr('r', function(d){
              return (d.value/100000)/4
            })
            .attr('class', function(d){ return d.key })
            .style('fill-opacity', 0.1)

		});

  </script>
</body>
</html>
